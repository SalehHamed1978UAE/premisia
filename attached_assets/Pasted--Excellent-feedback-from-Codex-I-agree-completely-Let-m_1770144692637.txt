 Excellent feedback from Codex! I agree completely. Let me revise to a
  tighter, more focused plan.

  ---
  ðŸŽ¯ REVISED PLAN: Prompts + Prefetch + Stable UI (Together)

  Key Adjustments Based on Codex:

  1. âœ… No new dependencies - Use built-in keyboard + click + wheel (skip
  @use-gesture)
  2. âœ… Keep page stable - Only the expanding section shows skeleton, not
  full page
  3. âœ… Breadcrumb shows Q+A - Full context for backtracking
  4. âœ… Subtle prefetch indicator - Corner badge, not center-screen
  5. âœ… Do everything together - Prompts + prefetch + UI are interconnected

  ---
  ðŸ“‹ IMPLEMENTATION CHECKLIST

  Phase 1: Backend (Prompts + Prefetch)

  File: server/strategic-consultant-legacy/whys-tree-generator.ts

  A. Import and enhance system prompt (Lines 1-15)

  // Add at top
  import { FIVE_WHYS_SYSTEM_PROMPT } from
  '../../shared/contracts/five-whys.schema.js';
  import { EventEmitter } from 'events';

  // Enhance with mechanism requirements
  const ENHANCED_SYSTEM_PROMPT = `${FIVE_WHYS_SYSTEM_PROMPT}

  CRITICAL: Every "why" answer must include:
  1. MECHANISM: What drives this (cause â†’ effect relationship)
  2. OBSERVABLE SIGNAL: What data would prove this
  3. DISCONFIRMING SIGNAL: What would falsify this claim

  BUSINESS DOMAINS ONLY:
  - Market dynamics, Customer behavior, Competition, Economics
  - Distribution, Regulation, Resources

  ANTI-PATTERNS (Reject):
  âœ— "You think/feel" âœ— "Because it's important" âœ— "Because it's new"`;

  B. Replace system prompt usage (Line 310)

  // BEFORE:
  let systemPrompt = 'You\'re a friendly business advisor...';

  // AFTER:
  let systemPrompt = ENHANCED_SYSTEM_PROMPT;

  C. Simplify main prompt (Lines 318-392 â†’ ~60 lines)

  userMessage: `Business challenge: ${context.input}

  Current question: ${question}

  ${context.history.length > 0 ? `Path so far:\n${context.history.map((step,
   i) => 
    `${i + 1}. Q: ${step.question}\n   A: ${step.answer}`).join('\n\n')}` : 
  ''}

  Depth: ${depth}/${this.maxDepth}

  Generate exactly 3 possible answers explaining WHY.

  EACH ANSWER REQUIRES:
  - MECHANISM: Causal relationship (X â†’ Y through Z)
  - OBSERVABLE SIGNAL: Specific evidence/data
  - DISCONFIRMING SIGNAL: What would prove this wrong
  - BUSINESS LENS: Tie to market/customer/competition/economics

  NO vague statements. Use specific numbers when possible.
  NO invented facts unless marked [ASSUMPTION].

  Return JSON:
  {
    "branches": [
      {
        "option": "Mechanism explaining why (cause â†’ effect)",
        "next_question": "Why [interrogate this specific answer]?",
        "supporting_evidence": ["Observable signal 1", "Observable signal 
  2"],
        "counter_arguments": ["Disconfirming signal 1", "Disconfirming 
  signal 2"],
        "consideration": "Neutral comparison insight"
      }
    ]
  }`;

  D. Fix root question prompt (Lines 225-240)

  userMessage: `Business challenge: ${input}

  Generate the root "Why" question for Five Whys analysis.

  REQUIREMENTS:
  1. Target SPECIFIC business success factor
  2. Answerable with market/competitive/customer data
  3. Focus on: customer choice, business model viability, competitive 
  advantage, market timing, economic feasibility
  4. NO therapy questions, NO vague questions

  EXAMPLES:
  âœ“ "Why would customers pay premium for this over alternatives?"
  âœ“ "Why would this business model generate sufficient margins?"
  âœ“ "Why would this succeed against existing market leaders?"

  Return JSON: {"question": "Why [specific, measurable factor]?"}`;

  E. Add prefetch infrastructure (New code after line 510)

  export class WhysTreeGenerator extends EventEmitter {
    private readonly maxDepth = 5;
    private groundingContext: OrchestrationResult | null = null;
    private cfContextPrompt: string = '';
    private branchCache: Map<string, WhyNode[]> = new Map(); // NEW

    constructor() {
      super();
      this.setMaxListeners(20); // Allow multiple concurrent prefetches
    }

    // NEW: Expand with prefetch
    async expandBranchWithPrefetch(
      nodeId: string,
      selectedPath: Array<{ question: string; answer: string }>,
      input: string,
      sessionId: string,
      currentDepth: number,
      parentQuestion: string,
      allSiblings?: WhyNode[]
    ): Promise<WhyNode[]> {

      // 1. Generate selected branch (foreground, blocking)
      const selectedBranches = await this.expandBranch(
        nodeId,
        selectedPath,
        input,
        sessionId,
        currentDepth,
        parentQuestion
      );

      // 2. Prefetch sibling branches (background, non-blocking)
      if (allSiblings && allSiblings.length > 1 && currentDepth <
  this.maxDepth - 1) {
        const otherSiblings = allSiblings.filter(s => s.id !== nodeId);

        // Emit start event
        this.emit('prefetch-start', {
          total: otherSiblings.length,
          sessionId
        });

        // Fire prefetch promises (don't await)
        let completed = 0;
        otherSiblings.forEach(sibling => {
          this.prefetchBranch(sibling, input, selectedPath, currentDepth,
  sessionId)
            .then(() => {
              completed++;
              this.emit('prefetch-progress', {
                completed,
                total: otherSiblings.length,
                sessionId
              });
            })
            .catch(err => console.warn('[Prefetch failed]', sibling.id,
  err));
        });
      }

      return selectedBranches;
    }

    // NEW: Prefetch a single branch
    private async prefetchBranch(
      node: WhyNode,
      input: string,
      history: Array<{ question: string; answer: string }>,
      currentDepth: number,
      sessionId: string
    ): Promise<void> {
      const cacheKey = `${sessionId}-${node.id}-${currentDepth}`;

      // Check cache
      if (this.branchCache.has(cacheKey)) {
        return;
      }

      // Build history including this node
      const extendedHistory = [
        ...history,
        { question: node.question, answer: node.option }
      ];

      // Generate branches
      const branches = await this.generateLevelInParallel(
        node.question,
        { input, history: extendedHistory },
        currentDepth + 1,
        node.id
      );

      // Cache result
      this.branchCache.set(cacheKey, branches);
    }

    // NEW: Check cache before generating
    getCachedBranches(sessionId: string, nodeId: string, depth: number):
  WhyNode[] | null {
      const cacheKey = `${sessionId}-${nodeId}-${depth}`;
      return this.branchCache.get(cacheKey) || null;
    }

    // NEW: Clear cache for session
    clearCache(sessionId: string): void {
      for (const key of this.branchCache.keys()) {
        if (key.startsWith(sessionId)) {
          this.branchCache.delete(key);
        }
      }
    }
  }

  ---
  File: server/routes/strategic-consultant-legacy.ts

  F. Update /expand endpoint (Lines 1145-1192)

  router.post('/whys-tree/expand', async (req: Request, res: Response) => {
    try {
      const {
        sessionId,
        nodeId,
        selectedPath,
        currentDepth,
        parentQuestion,
        input,
        allSiblings // NEW: receive all siblings for prefetch
      } = req.body;

      const generator = new WhysTreeGenerator();

      // Check cache first
      const cached = generator.getCachedBranches(sessionId, nodeId,
  currentDepth);
      if (cached) {
        console.log(`[Cache hit] nodeId=${nodeId}, depth=${currentDepth}`);
        return res.json({ expandedBranches: cached, fromCache: true });
      }

      // Use prefetch-aware method
      const expandedBranches = await generator.expandBranchWithPrefetch(
        nodeId,
        selectedPath,
        input,
        sessionId,
        currentDepth,
        parentQuestion,
        allSiblings
      );

      res.json({ expandedBranches, fromCache: false });
    } catch (error: any) {
      console.error('Error in /whys-tree/expand:', error);
      res.status(500).json({ error: error.message });
    }
  });

  ---
  Phase 2: Frontend (Stable UI + Keyboard Nav)

  File: client/src/pages/strategic-consultant/WhysTreePage.tsx

  G. Add prefetch state (Lines 70-85)

  const [isPrefetching, setIsPrefetching] = useState(false);
  const [prefetchProgress, setPrefetchProgress] = useState({ completed: 0,
  total: 0 });

  H. Enhanced breadcrumb (Lines 924-1033)

  // Replace current breadcrumb with Q+A version
  <Collapsible open={isBreadcrumbExpanded}
  onOpenChange={setIsBreadcrumbExpanded}>
    <Card className="bg-muted/30">
      <CardContent className="p-4">
        <CollapsibleTrigger asChild>
          <button className="flex items-center justify-between w-full 
  text-left">
            <span className="text-sm font-medium">Your Path
  ({selectedPath.length} levels deep)</span>
            <ChevronDown className={`h-4 w-4 transition-transform 
  ${isBreadcrumbExpanded ? 'rotate-180' : ''}`} />
          </button>
        </CollapsibleTrigger>

        {!isBreadcrumbExpanded && (
          <div className="mt-2">
            <p className="text-lg font-bold 
  text-primary">{getCurrentQuestion()}</p>
          </div>
        )}

        <CollapsibleContent>
          <div className="mt-4 space-y-3">
            {selectedPath.map((item, i) => (
              <button
                key={i}
                onClick={() => jumpToLevel(i + 1)}
                className="w-full text-left p-3 rounded-lg hover:bg-muted/50
   transition-colors"
              >
                <Badge variant="outline" className="mb-1">{getOrdinalLabel(i
   + 1)}</Badge>
                <p className="text-sm font-medium">{item.question}</p>
                <div className="flex items-center gap-2 mt-1 text-xs 
  text-muted-foreground">
                  <ArrowRight className="h-3 w-3" />
                  <span>{item.answer}</span>
                </div>
              </button>
            ))}
          </div>
        </CollapsibleContent>
      </CardContent>
    </Card>
  </Collapsible>

  I. Replace full-page loading with skeleton (Lines 1036-1048)

  // REMOVE this:
  {expandBranchMutation.isPending ? (
    <Card className="border-2">
      <CardContent className="py-12">
        <Loader2 className="h-12 w-12 animate-spin" />
      </CardContent>
    </Card>
  ) : (

  // REPLACE WITH stable layout + skeleton for expanding branch only:
  {currentOptions.length > 0 ? (
    <>
      {/* Show options grid */}
      <div className="grid sm:grid-cols-2 gap-3">
        {currentOptions.map(option => (
          <Card key={option.id} /* ... */ />
        ))}
      </div>

      {/* Show skeleton for next level if expanding */}
      {expandBranchMutation.isPending && selectedOptionId && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: 'auto' }}
          className="mt-4"
        >
          <Card className="border-dashed">
            <CardContent className="p-4">
              <div className="flex items-center gap-3">
                <Loader2 className="h-5 w-5 animate-spin text-primary" />
                <div className="flex-1">
                  <div className="h-4 bg-muted animate-pulse rounded mb-2" 
  />
                  <div className="h-3 bg-muted animate-pulse rounded w-3/4" 
  />
                </div>
              </div>
            </CardContent>
          </Card>
        </motion.div>
      )}
    </>
  ) : (

  J. Add subtle prefetch indicator (After line 1460)

  {/* Prefetch Progress Indicator - Bottom right corner */}
  {isPrefetching && prefetchProgress.total > 0 && (
    <motion.div
      initial={{ opacity: 0, scale: 0.8, y: 20 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      exit={{ opacity: 0, scale: 0.8, y: 20 }}
      className="fixed bottom-6 right-6 z-50"
    >
      <Card className="shadow-lg border-primary/20">
        <CardContent className="p-3 flex items-center gap-2">
          <div className="relative w-6 h-6">
            <svg className="absolute inset-0 -rotate-90" viewBox="0 0 24 
  24">
              <circle
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="2"
                fill="none"
                className="text-muted"
              />
              <circle
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="2"
                fill="none"
                className="text-primary transition-all duration-300"
                strokeDasharray={`${(prefetchProgress.completed / 
  prefetchProgress.total) * 62.8} 62.8`}
              />
            </svg>
          </div>
          <span className="text-xs text-muted-foreground">
            Preparing {prefetchProgress.completed}/{prefetchProgress.total}
          </span>
        </CardContent>
      </Card>
    </motion.div>
  )}

  K. Add keyboard navigation (After line 350)

  // Keyboard navigation
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      // Don't intercept if user is typing
      if (e.target instanceof HTMLInputElement || e.target instanceof
  HTMLTextAreaElement) {
        return;
      }

      const currentOptions = getCurrentOptions();
      if (currentOptions.length === 0) return;

      const currentIndex = selectedOptionId
        ? currentOptions.findIndex(o => o.id === selectedOptionId)
        : -1;

      switch(e.key) {
        case 'ArrowUp':
        case 'ArrowLeft':
          e.preventDefault();
          if (currentIndex === -1) {
            setSelectedOptionId(currentOptions[0].id);
          } else {
            const prevIndex = (currentIndex - 1 + currentOptions.length) %
  currentOptions.length;
            setSelectedOptionId(currentOptions[prevIndex].id);
          }
          break;

        case 'ArrowDown':
        case 'ArrowRight':
          e.preventDefault();
          if (currentIndex === -1) {
            setSelectedOptionId(currentOptions[0].id);
          } else {
            const nextIndex = (currentIndex + 1) % currentOptions.length;
            setSelectedOptionId(currentOptions[nextIndex].id);
          }
          break;

        case 'Enter':
          e.preventDefault();
          if (selectedOptionId && !isProcessingAction) {
            if (currentLevel >= 5) {
              handleFinalize();
            } else {
              handleSelectAndContinue();
            }
          }
          break;

        case 'Backspace':
          e.preventDefault();
          if (currentLevel > 1 && !isProcessingAction) {
            handleBackLevel();
          }
          break;

        case 'Escape':
          e.preventDefault();
          setSelectedOptionId(null);
          break;
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [selectedOptionId, currentLevel, currentOptions, isProcessingAction]);

  // Show keyboard hints on first visit
  useEffect(() => {
    const hasSeenHints = localStorage.getItem('whys-keyboard-hints-seen');
    if (!hasSeenHints && currentLevel === 1) {
      toast({
        title: "ðŸ’¡ Keyboard shortcuts",
        description: "â†‘â†“ or â†â†’ to navigate, Enter to select, Backspace to go
   back",
        duration: 5000,
      });
      localStorage.setItem('whys-keyboard-hints-seen', 'true');
    }
  }, [currentLevel]);

  L. Update expand mutation to pass siblings (Line 110-168)

  const expandBranchMutation = useMutation({
    mutationFn: async ({ nodeId, parentQuestion, currentDepth, isCustom,
  customOption }: {
      nodeId: string;
      parentQuestion: string;
      currentDepth: number;
      isCustom?: boolean;
      customOption?: string;
    }) => {
      if (!understanding) {
        throw new Error('Understanding data not loaded');
      }

      const pathHistory = selectedPath.map(p => ({ question: p.question,
  answer: p.answer }));
      const currentOptions = getCurrentOptions(); // NEW: get current 
  options

      const response = await apiRequest('POST',
  '/api/strategic-consultant/whys-tree/expand', {
        sessionId: understanding.sessionId,
        nodeId,
        selectedPath: pathHistory,
        currentDepth,
        parentQuestion,
        input: understanding.userInput,
        isCustom: isCustom || false,
        customOption,
        allSiblings: currentOptions // NEW: pass for prefetch
      });

      return response.json();
    },
    onSuccess: (data: any, variables) => {
      setIsProcessingAction(false);

      // Show cache hit notification
      if (data.fromCache) {
        toast({
          title: "âš¡ Instant",
          description: "Already prepared this path",
          duration: 2000,
        });
      }

      if (data.expandedBranches && tree) {
        // Update tree...
      }
    },
    // ... rest unchanged
  });

  M. Add jump to level function (New function)

  const jumpToLevel = (targetLevel: number) => {
    if (targetLevel < 1 || targetLevel > selectedPath.length + 1) return;

    // Trim path to target level
    const newPath = selectedPath.slice(0, targetLevel - 1);
    setSelectedPath(newPath);
    setCurrentLevel(targetLevel);
    setSelectedOptionId(null);

    toast({
      title: "Navigated",
      description: `Jumped to Level ${targetLevel}`,
      duration: 2000,
    });
  };

  const handleBackLevel = () => {
    if (currentLevel > 1) {
      jumpToLevel(currentLevel - 1);
    }
  };

  ---
  ðŸ“¦ NO NEW DEPENDENCIES

  Everything uses what's already installed:
  - âœ… framer-motion (already there)
  - âœ… Built-in keyboard events
  - âœ… Built-in click events
  - âœ… CSS for hover/active states

  ---
  ðŸŽ¯ SUMMARY OF CHANGES

  | Component      | Change                           | Lines | Files
                     |
  |----------------|----------------------------------|-------|-------------
  -------------------|
  | System Prompt  | Use schema + add mechanism rules | ~20   |
  whys-tree-generator.ts         |
  | Main Prompt    | Simplify 1800â†’900 chars          | -100  |
  whys-tree-generator.ts         |
  | Root Prompt    | Fix vague questions              | ~20   |
  whys-tree-generator.ts         |
  | Prefetch Logic | Add cache + background fetch     | +150  |
  whys-tree-generator.ts         |
  | API Endpoint   | Support siblings + cache         | ~30   |
  strategic-consultant-legacy.ts |
  | Breadcrumb     | Show Q+A, add jump nav           | ~40   |
  WhysTreePage.tsx               |
  | Loading State  | Replace full-page with skeleton  | ~30   |
  WhysTreePage.tsx               |
  | Keyboard Nav   | Arrow keys + Enter/Backspace     | ~70   |
  WhysTreePage.tsx               |
  | Prefetch UI    | Corner badge progress            | ~30   |
  WhysTreePage.tsx               |

  Total: ~390 lines changed/added across 3 files

  ---
  âœ… READY TO EXECUTE

  This plan:
  - âœ… Fixes prompts (mechanism + evidence + falsifier)
  - âœ… Adds speculative prefetch (background sibling generation)
  - âœ… Keeps UI stable (no full-page loading)
  - âœ… Adds keyboard navigation (no new dependencies)
  - âœ… Shows subtle prefetch progress (corner badge)
  - âœ… Improves breadcrumb (Q+A + jump navigation)

  Do you want me to apply these changes now?

  Say: "Apply all changes" and I'll execute.