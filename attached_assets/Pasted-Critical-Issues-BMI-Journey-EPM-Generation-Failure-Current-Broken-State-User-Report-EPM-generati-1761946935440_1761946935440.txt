Critical Issues: BMI Journey & EPM Generation Failure
Current Broken State
User Report: EPM generation is stuck at 0% for Strategic Consultant journey (BMI). The journey appears to complete but EPM generation fails.

Symptoms:

BMI journey shows Porter's Five Forces analysis pages ("Updating strategic decisions", "Strategy Analysis Results") when it shouldn't
EPM generation fails with error: Error: No BMC analysis found for this version
Background job stuck at 5% progress: "Preparing strategic analysis..."
Root Causes (3 Critical Bugs)
Bug #1: SessionId/UnderstandingId Mismatch
Location: Journey initialization & storage

What's happening:

Journey type is stored as: journey-type-${understandingId} (e.g., journey-type-02c9a5f5-f39a-4d72-9504-951bc08487d0)
ResearchPage tries to retrieve it as: journey-type-${sessionId} (e.g., journey-type-session-1761945391549-iqi9bs)
Lookup fails, returns null
ResearchPage thinks it's NOT a BMI journey
Therefore calls Porter's analysis endpoints
Evidence from logs:

Browser: journeyType stored for understandingId: "02c9a5f5-f39a-4d72-9504-951bc08487d0"
Server: Research uses sessionId: "session-1761945391549-iqi9bs"
ResearchPage: localStorage.getItem(`journey-type-${sessionId}`) → null

Bug #2: Hardcoded Conditional Logic in ResearchPage
Location: client/src/pages/strategic-consultant/ResearchPage.tsx lines 243-305

Architectural problem:
ResearchPage has hardcoded logic checking journeyType === 'business_model_innovation' to decide whether to run Porter's analysis. This defeats the entire purpose of the modular journey builder.

Current flow:

// Line 243-250: Should skip Porter's
if (journeyType === 'business_model_innovation') {
  setDecisionsUpdated(true);
  setAutoNavigateCountdown(3);
  return; // Skip Porter's
}
// Lines 254-305: Runs Porter's analysis
await apiRequest('POST', '/api/strategic-consultant/analyze-enhanced', {...}); // Porter's
await apiRequest('POST', '/api/strategic-consultant/decisions/generate-with-research', {...});

Why this is wrong:

Journey orchestrator should control which frameworks run based on journey config
Frontend pages shouldn't have framework-specific conditional logic
This creates tight coupling and prevents the modular system from working
Bug #3: BMC Analysis Results Not Saved
Location: BMC research completion flow

What should happen:

BMC research completes (logs show this works: 8 queries, sources analyzed)
BMC analysis results should be saved to strategy_versions.analysisResults
EPM generation should find and use those results
What actually happens:

BMC research completes ✓
ResearchPage calls Porter's analysis instead (due to Bug #1)
BMC results never get saved
EPM generation queries for BMC analysis, finds nothing, fails
Evidence from logs:

9:19:57 - BMC research completes successfully
9:20:28 - POST /api/strategic-consultant/analyze-enhanced (Porter's - shouldn't run!)
9:21:03 - POST /api/strategic-consultant/decisions/generate-with-research
9:23:50 - EPM generation: Error: No BMC analysis found for this version

User's Valid Concern
User Quote: "i don't even understand why porters is being 'skipped' i thought we modernized and modularized and created the journey builder so we wouldn't have a situation like you are describing"

They're 100% right. The journey builder exists to prevent exactly this kind of hardcoded conditional logic. The architecture should be:

Journey config defines which frameworks run in what order
Journey orchestrator executes frameworks based on config
Frontend pages are dumb renderers with no framework-specific logic
Each framework saves its results independently
Proper Fix (No Band-Aids)
Fix #1: Resolve SessionId Consistency
Action: Ensure sessionId is used consistently throughout the journey lifecycle

Search for:

Where understandingId gets converted to sessionId (journey execution endpoint)
Where journey type is stored (JourneySelection page)
Where journey type is retrieved (ResearchPage)
Fix: Store journey type with the actual sessionId that will be used throughout the journey, not the understandingId.

Fix #2: Remove Hardcoded Logic from ResearchPage
Action: Delete all journey-type-specific conditional logic from ResearchPage

What to remove:

Lines 243-250: BMI journey check
Lines 254-305: Porter's analysis calls
All journeyType === 'business_model_innovation' checks
Replace with: Generic research completion handler that:

Marks research complete
Auto-navigates to next page in journey config
No framework-specific logic
Fix #3: Move Framework Execution to Journey Orchestrator
Action: Journey orchestrator should handle which frameworks run after research

Architecture:

Journey Config → Defines: [Five Whys, BMC Research, Strategic Decisions]
                 (NO Porter's for BMI journey)
Journey Orchestrator → After BMC research completes:
  - Saves BMC results to database
  - Triggers next step in journey (Strategic Decisions)
  - NO conditional logic based on journey type
ResearchPage → Generic:
  - Shows research progress
  - Navigates to next page when complete
  - Doesn't know/care about frameworks

Fix #4: Ensure BMC Results Are Saved
Action: BMC research completion must save analysis results to strategy_versions.analysisResults

Check:

server/routes/strategic-consultant.ts - research stream endpoint
BMC research completion handler
Where analysisResults JSON field gets populated
Verify: EPM generation can find BMC analysis by querying strategy_versions with sessionId and versionNumber.

Investigation Checklist
Before fixing, search for:

SessionId generation/transformation:

grep -r "understandingId" server/routes/
Find where understandingId → sessionId conversion happens
Trace journey execution flow
Journey type storage:

grep -r "journey-type" client/src/
Find all localStorage.setItem calls
Find all localStorage.getItem calls
Ensure consistent keys
Framework execution triggers:

grep -r "analyze-enhanced" client/
grep -r "analyze-enhanced" server/
Find all places that trigger Porter's analysis
Determine if they should be in orchestrator instead
BMC results persistence:

grep -r "analysisResults" server/
Find where BMC results should be saved
Verify save happens after research completes
Success Criteria
After fixes:

✓ BMI journey runs ONLY Five Whys → BMC Research → Strategic Decisions (no Porter's pages)
✓ BMC analysis results saved to database after research completes
✓ EPM generation finds BMC analysis and succeeds
✓ No hardcoded journey-type checks in frontend pages
✓ Journey orchestrator controls all framework execution
✓ SessionId/understandingId used consistently throughout
Test Plan
Start new BMI journey through Strategic Consultant
Complete Five Whys analysis
Wait for BMC research to complete (don't click anything)
Verify: Goes directly to Strategic Decisions (no Porter's pages)
Make strategic decisions
Launch EPM generation
Verify: EPM generation succeeds (finds BMC analysis)
Verify: EPM program created with all 14 components
Bottom Line: This requires a proper architectural fix, not conditional patching. The modular journey builder exists - it just needs the hardcoded logic removed so it can actually work.